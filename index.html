<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SPIRE LAB — India Map (States → Districts)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body { height:100%; margin:0; padding:0; }
    body { background:#071423; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#e6f7fb; }

    #topbar {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      height: 110px;
      z-index: 1400;
      display: flex;
      align-items: center;
      padding: 12px 22px;
      background: linear-gradient(180deg,#051220,#072031);
      box-shadow: 0 2px 12px rgba(0,0,0,.45);
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }
    #topbar .logo-wrap { display:flex; align-items:center; gap:16px; flex: 0 0 auto; }
    #topbar .logo-wrap img { height:72px; width:auto; display:block; border-radius:4px; object-fit:contain; background:transparent; }
    #svgLogo { display:none; height:72px; width:auto; }
    #topbar .title { display:flex; flex-direction:column; line-height:1.05; margin-left:6px; overflow:visible; }
    #topbar .title .main { font-size:30px; font-weight:800; color:#ff6a2b; letter-spacing:1px; }
    #topbar .title .sub { margin-top:6px; font-size:16px; color:#d7eef6; font-weight:600; max-width: calc(100vw - 240px); white-space: normal; line-height:1.12; word-break: break-word; }

    #map { position: absolute; top: 110px; left:0; right: calc(200px + 40px); bottom:0; } /* leave room for info panel */
    #info {
      position: fixed;
      top: 160px;
      right: 40px;
      width: 200px;
      height: calc(100% - 110px);
      background: linear-gradient(180deg,#041722,#052b39);
      color: #e9fbff;
      padding: 18px;
      box-shadow: none;
      overflow:auto;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      z-index: 2000;           
    pointer-events: auto;
    }
    #info h2 { margin:0 0 8px 0; font-size:18px; color:#ffd3a8; }
    #info .label { font-weight:700; color:#bfeef7; margin-top:10px; }
    #info .value { font-weight:600; color:#e9fbff; }

    .state-label { display:inline-block; font-weight:700; color:#052; background:#a8f2ffcc; padding:4px 8px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.35); white-space:nowrap; font-size:13px; transform: translate(-50%, -50%); pointer-events: none; }
    .district-tooltip { background: rgba(255,255,255,0.95); color:#022; padding:5px 8px; border-radius:6px; border:1px solid rgba(0,0,0,0.08); font-size:12px; }
    .leaflet-container { outline: none !important;
  border: none !important;
  background: #071423; }

 #map .leaflet-top.leaflet-left {
      top: 60px;   
      
    }  @media (max-width:1000px) {
      #map { right:0; } 
      #info { display:none; }
    }
  </style>
</head>
<body>
  <div id="topbar" role="banner" aria-label="SPIRE LAB header">
    <div class="logo-wrap" aria-hidden="false">
      <img id="logoImg" src="https://spire.ee.iisc.ac.in/assets/images/Public/spire_logo.png" alt="SPIRE LAB logo" onerror="this.style.display='none'; document.getElementById('svgLogo').style.display='block'">
      <svg id="svgLogo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><defs><linearGradient id="g1"><stop offset="0%" stop-color="#ff9c2e"/><stop offset="60%" stop-color="#d85b16"/><stop offset="100%" stop-color="#722000"/></linearGradient></defs><g transform="translate(100,100) scale(0.9)"><path d="M0,-90 C25,-60 40,-10 45,45 C30,40 10,20 -5,5 C-20,20 -40,40 -55,45 C-50,-10 -35,-60 0,-90 Z" fill="url(#g1)" stroke="#5b1e00" stroke-opacity="0.6" stroke-width="0.8"/><ellipse cx="0" cy="60" rx="55" ry="15" fill="#7a2800" opacity="0.65"/></g></svg>
    </div>
    <div class="title" role="heading" aria-level="1">
      <div class="main">SPIRE LAB</div>
      <div class="sub">Signal Processing Interpretation and REPresentation LABoratory — Prof. Prasanta Kumar Ghosh</div>
    </div>
  </div>

  <div id="map"></div>

  <div id="info" aria-live="polite">
    <h2>District Data</h2>
    <div id="infoContent">
      <p>Select a district to view statistics. If the district is not in the provided dataset you'll see "No Data Available".</p>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
 
  const districtData = {
    "mysuru": { language:"Kannada", questions:100, answers:100, male:1, female:1, rated:3 },
    "dharwad": { language:"Kannada", questions:100, answers:100, male:1, female:1, rated:3 },
    "kalaburagi": { language:"Kannada", questions:100, answers:100, male:1, female:1, rated:3 },
    "dakshina kannada": { language:"Kannada", questions:100, answers:100, male:1, female:1, rated:3 },
    "ballari": { language:"Kannada", questions:100, answers:100, male:1, female:1, rated:3 },

    "guntur": { language:"Telugu", questions:100, answers:100, male:1, female:1, rated:3 },
    "karimnagar": { language:"Telugu", questions:100, answers:100, male:1, female:1, rated:3 },
    "srikakulam": { language:"Telugu", questions:100, answers:100, male:1, female:1, rated:3 },
    "chittoor": { language:"Telugu", questions:100, answers:100, male:1, female:1, rated:3 },

    "muzaffarnagar": { language:"Hindi", questions:100, answers:100, male:1, female:1, rated:3 },
    "etah": { language:"Hindi", questions:100, answers:100, male:1, female:1, rated:3 },
    "hamirpur": { language:"Hindi", questions:100, answers:100, male:1, female:1, rated:3 },
    "nagaur": { language:"Hindi", questions:100, answers:100, male:1, female:1, rated:3 },
    "tehri garhwal": { language:"Hindi", questions:100, answers:100, male:1, female:1, rated:3 },

    "varanasi": { language:"Bhojpuri", questions:100, answers:100, male:1, female:1, rated:3 },
    "east champaran": { language:"Bhojpuri", questions:100, answers:100, male:1, female:1, rated:3 },
    "deoria": { language:"Bhojpuri", questions:100, answers:100, male:1, female:1, rated:3 },
    "saran": { language:"Bhojpuri", questions:100, answers:100, male:1, female:1, rated:3 },

    "kabeerdham": { language:"Chhattisgarhi", questions:100, answers:100, male:1, female:1, rated:3 },
    "bilaspur": { language:"Chhattisgarhi", questions:100, answers:100, male:1, female:1, rated:3 },
    "raigarh": { language:"Chhattisgarhi", questions:100, answers:100, male:1, female:1, rated:3 },
    "surguja": { language:"Chhattisgarhi", questions:100, answers:100, male:1, female:1, rated:3 },

    "gaya": { language:"Magahi", questions:120, answers:120, male:1, female:1, rated:3 },
    "kishanganj": { language:"Magahi", questions:120, answers:120, male:1, female:1, rated:3 },
    "lakhisarai": { language:"Magahi", questions:120, answers:120, male:1, female:1, rated:3 },
    "vaishali": { language:"Magahi", questions:120, answers:120, male:1, female:1, rated:3 },

    "scb": { language:"Bengali", questions:100, answers:100, male:1, female:1, rated:3 },
    "purulia": { language:"Bengali", questions:100, answers:100, male:1, female:1, rated:2 },
    "jalpaiguri": { language:"Bengali", questions:100, answers:100, male:1, female:1, rated:0 },
    "west medinipur": { language:"Bengali", questions:100, answers:100, male:1, female:1, rated:0 },
    "malda": { language:"Bengali", questions:100, answers:100, male:1, female:1, rated:0 },

    "pune": { language:"Marathi", questions:100, answers:100, male:1, female:1, rated:2 },
    "nashik": { language:"Marathi", questions:100, answers:100, male:1, female:1, rated:3 },
    "nagpur": { language:"Marathi", questions:100, answers:100, male:1, female:1, rated:2 },
    "sindhudurg": { language:"Marathi", questions:100, answers:100, male:1, female:1, rated:0 },
    "dhule": { language:"Marathi", questions:100, answers:100, male:1, female:1, rated:2 },

    "saharsa": { language:"Maithili", questions:100, answers:100, male:1, female:1, rated:3 },
    "madhepura": { language:"Maithili", questions:100, answers:100, male:1, female:1, rated:3 },
    "bhagalpur": { language:"Maithili", questions:100, answers:100, male:1, female:1, rated:3 },
    "madhubani": { language:"Maithili", questions:100, answers:100, male:1, female:1, rated:3 },

   
  };

  function getDistrictKey(name){
    if(!name) return null;
    return name.toString().toLowerCase().trim();
  }

  function showInfoHtml(title, html){
    const c = document.getElementById('infoContent');
    c.innerHTML = `<h3 style="margin-top:8px;color:#ffd3a8">${title}</h3>` + html;
  }

  function showNoData(name){
    showInfoHtml(name, `<p style="margin-top:10px">No Data Available</p>`);
  }

  function showStats(name, stats){
    const html = `
      <div class="label">Language</div><div class="value">${stats.language}</div>
      <div class="label">Questions created</div><div class="value">${stats.questions}</div>
      <div class="label">Answers created</div><div class="value">${stats.answers}</div>
      <div class="label">Male speakers Q&A</div><div class="value">${stats.male}</div>
      <div class="label">Female speakers Q&A</div><div class="value">${stats.female}</div>
      <div class="label">People rated Q&A</div><div class="value">${stats.rated}</div>
    `;
    showInfoHtml(name, html);
  }

  const TOPOJSON_PATH = './topojson/india.json';
  const GEOJSON_PATH  = './geojson/india.geojson';
  const LABEL_MIN_ZOOM = 5.6;
  const LABEL_MAX_ZOOM = 7.6;
  const SHOW_DISTRICT_ZOOM = 8.0;
  const MIN_LABEL_SEPARATION_PX = 60;

  function setInfo(msg){ console.log('[map] ' + msg); }

  const map = L.map('map', { zoomControl:true, minZoom:4, maxZoom:12, preferCanvas:true }).setView([22,79], 5);

  let indiaFC = null, mergedStatesFC = null, statesLayer = null;
  let centroidList = [], labelMarkers = [], currentDistrictLayer = null;
  let stateBuckets = {}, stateKey = null, activeStateName = null;

  async function loadIndiaFile(){
    const tries = [TOPOJSON_PATH, GEOJSON_PATH];
    for (const p of tries) {
      try {
        const res = await fetch(p);
        if (!res.ok) throw new Error('not found');
        const j = await res.json();
        if (j.type === 'Topology' || j.objects) {
          const k = Object.keys(j.objects)[0];
          return topojson.feature(j, j.objects[k]);
        } else return j;
      } catch(e) {}
    }
    throw new Error('India file not found. Place topojson/india.json or geojson/india.geojson in project.');
  }

  function detectStateProperty(features) {
    const sample = features.slice(0, Math.min(1500, features.length));
    const counts = {};
    sample.forEach(f => {
      const p = f.properties || {};
      Object.keys(p).forEach(k => {
        if (p[k] != null) {
          counts[k] = counts[k] || new Set();
          counts[k].add(String(p[k]).trim());
        }
      });
    });
    let best = null;
    for (const k of Object.keys(counts)) {
      const n = counts[k].size;
      if (n >= 10 && n <= 50) {
        if (!best) best = k;
        else if (Math.abs(n-36) < Math.abs(counts[best].size - 36)) best = k;
      }
    }
    if (!best) {
      const cand = ['st_nm','STATE','state','ST_NAME','ST_NM','STATE_NAME','stname'];
      for (const c of cand) if (counts[c]) { best = c; break; }
    }
    return best || Object.keys(sample[0]?.properties || {})[0] || null;
  }

  function buildBuckets(features, key) {
    const buckets = {};
    features.forEach(f => {
      const name = String((f.properties && f.properties[key]) || 'Unknown').trim();
      buckets[name] = buckets[name] || [];
      buckets[name].push(f);
    });
    return buckets;
  }

  function mergePairwise(features) {
    if (!features || features.length === 0) return null;
    const simple = features.map(f => { try { return turf.simplify(f, { tolerance:0.0015, highQuality:false }); } catch { return f; } });
    let queue = simple.slice();
    while (queue.length > 1) {
      const a = queue.shift(), b = queue.shift();
      try {
        const merged = turf.union(a,b) || a;
        try { queue.push(turf.simplify(merged, { tolerance:0.0018, highQuality:false })); } catch { queue.push(merged); }
      } catch(e) {
        try { queue.push(turf.buffer(a,0)||a); queue.push(turf.buffer(b,0)||b); } catch { queue.push(a); queue.push(b); }
      }
      if (queue.length > 60) queue = queue.map(x => { try { return turf.simplify(x,{tolerance:0.0022,highQuality:false}); } catch { return x; } });
    }
    try { return turf.simplify(queue[0], { tolerance:0.0025, highQuality:false }); } catch { return queue[0]; }
  }

  async function buildMergedStates(buckets) {
    const names = Object.keys(buckets).sort();
    const merged = [];
    let i = 0;
    for (const name of names) {
      i++;
      setInfo(`Merging ${i}/${names.length}: ${name}`);
      const feats = buckets[name];
      const mergedFeat = mergePairwise(feats) || feats[0];
      mergedFeat.properties = mergedFeat.properties || {};
      mergedFeat.properties._stateName = name;
      merged.push(mergedFeat);
      await new Promise(r => setTimeout(r, 20));
    }
    setInfo('Merged all states.');
    return turf.featureCollection(merged);
  }

  function renderStatesAndCentroids(statesFC) {
    if (statesLayer) map.removeLayer(statesLayer);
    statesLayer = L.geoJSON(statesFC, {
      style: { weight:1.0, color:'#032b3a', fillColor:'#0ab7e0', fillOpacity:0.95 },
      onEachFeature: (feature, layer) => {
        layer.on({
          mouseover: () => layer.setStyle({ weight:2.2, color:'#001f3f', fillColor:'#79eeff', fillOpacity:0.98 }),
          mouseout: () => statesLayer.resetStyle(layer),
          click: () => {
            const nm = feature.properties && (feature.properties._stateName || feature.properties[stateKey]) || 'State';
            const bounds = layer.getBounds();
            if (bounds && bounds.isValid()) map.fitBounds(bounds.pad(0.03), { maxZoom: 10 });
            drawStateDistricts(nm);
          }
        });
      }
    }).addTo(map);

    centroidList = [];
    statesFC.features.forEach(f => {
      try {
        const c = turf.centroid(f).geometry.coordinates;
        centroidList.push({ name: f.properties._stateName, lat: c[1], lng: c[0] });
      } catch(e){}
    });
  }

  function updateLabels() {
    labelMarkers.forEach(m => map.removeLayer(m));
    labelMarkers = [];

    const z = map.getZoom();
    if (z < LABEL_MIN_ZOOM || z > LABEL_MAX_ZOOM) return;
    if (currentDistrictLayer) return;

    const placed = [];
    centroidList.forEach(c => {
      const ll = L.latLng(c.lat, c.lng);
      if (!map.getBounds().contains(ll)) return;
      const p = map.latLngToLayerPoint(ll);
      const tooClose = placed.some(q => {
        const dx = q.x - p.x, dy = q.y - p.y;
        return (dx*dx + dy*dy) < (MIN_LABEL_SEPARATION_PX * MIN_LABEL_SEPARATION_PX);
      });
      if (tooClose) return;
      const icon = L.divIcon({ className: '', html: `<div class="state-label">${c.name}</div>`, iconSize: null });
      const marker = L.marker(ll, { icon: icon, interactive:false, zIndexOffset:6000 });
      marker.addTo(map);
      labelMarkers.push(marker);
      placed.push(p);
    });
  }

  function findStateContainingPoint(pt) {
    if (!mergedStatesFC) return null;
    for (const f of mergedStatesFC.features) {
      try {
        if (turf.booleanPointInPolygon(pt, f)) return f.properties._stateName;
      } catch(e){}
    }
    return null;
  }

  function drawStateDistricts(stateName) {
    if (!stateBuckets[stateName] || !stateBuckets[stateName].length) { setInfo('No districts for ' + stateName); return; }
    if (activeStateName === stateName && currentDistrictLayer) return;
    if (currentDistrictLayer) { map.removeLayer(currentDistrictLayer); currentDistrictLayer = null; }
    activeStateName = stateName;
    const fc = turf.featureCollection(stateBuckets[stateName]);
    currentDistrictLayer = L.geoJSON(fc, {
      style: { weight:0.9, color:'#023b4a', fillColor:'#0ab7e0', fillOpacity:0.85 },
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const dname = (p.district || p.DISTRICT || p.NAME || p.name || p.NAME_1 || p.DISTRICT_NAME || 'District').toString();
        layer.bindTooltip(dname, { className:'district-tooltip', direction:'center', sticky:false });

        layer.on({
          mouseover: ()=> layer.setStyle({ weight:1.6, color:'#001f3f', fillOpacity:0.98 }),
          mouseout: ()=> currentDistrictLayer.resetStyle(layer),
          click: (e) => {
            const key = getDistrictKey(dname);
            if (districtData[key]) showStats(dname, districtData[key]);
            else showNoData(dname);
          }
        });
      },
      preferCanvas: true
    }).addTo(map);

    labelMarkers.forEach(m => map.removeLayer(m));
    setInfo('Showing districts for ' + stateName);
    if (map.getZoom() < SHOW_DISTRICT_ZOOM) currentDistrictLayer.setStyle({ opacity:0, fillOpacity:0 });
  }

  function hideDistricts() {
    if (currentDistrictLayer) { map.removeLayer(currentDistrictLayer); currentDistrictLayer = null; }
    activeStateName = null;
    updateLabels();
  }

  let zoomTimer = null;
  function onZoomOrMove() {
    clearTimeout(zoomTimer);
    zoomTimer = setTimeout(() => {
      const z = map.getZoom();
      if (z >= SHOW_DISTRICT_ZOOM) {
        const c = map.getCenter();
        const pt = turf.point([c.lng, c.lat]);
        const state = findStateContainingPoint(pt);
        if (state) drawStateDistricts(state);
      } else {
        hideDistricts();
      }
      updateLabels();
    }, 160);
  }

  (async function init(){
    try {
      setInfo('Loading India geometry (topo/geo)…');
      indiaFC = await loadIndiaFile();
      const feats = indiaFC.features || [];
      if (!feats.length) throw new Error('No features found in India file.');

      setInfo('Detecting state property & grouping districts…');
      stateKey = detectStateProperty(feats);
      stateBuckets = buildBuckets(feats, stateKey);

      setInfo('Merging districts into states (one-time; please wait)…');
      mergedStatesFC = await buildMergedStates(stateBuckets);

      setInfo('Rendering merged states & computing centroids…');
      renderStatesAndCentroids(mergedStatesFC);

      const bounds = statesLayer.getBounds();
      if (bounds && bounds.isValid()) {
        map.fitBounds(bounds.pad(0.02));
        map.setMaxBounds(bounds.pad(0.25));
        map.options.maxBoundsViscosity = 1.0;
      }

      updateLabels();
      map.on('zoomend', onZoomOrMove);
      map.on('moveend', onZoomOrMove);

      setInfo('Ready — states-only view; zoom into a state to auto-show its districts.');
    } catch (err) {
      console.error(err);
      alert('Failed to load India data. Open console for details.');
      setInfo('Error loading India geometry.');
    }
  })();
  </script>
</body>
</html>
